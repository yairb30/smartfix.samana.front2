<div class="form-container">
  @if (isLoadingData) {
    <div class="loading-overlay">
      <app-spinner 
        size="large" 
        message="Cargando datos del formulario..."
        color="primary">
      </app-spinner>
    </div>
  } @else if (isLoading) {
    <div class="loading-overlay">
      <app-spinner 
        size="large" 
        message="Cargando datos de la reparaci√≥n..."
        color="primary">
      </app-spinner>
    </div>
  } @else {
    <div class="form-card">
      <div class="form-header">
        <div class="form-icon">üõ†Ô∏è</div>
        <h2 class="form-title">{{ isEditMode ? "Editar Reparaci√≥n" : "Nueva Reparaci√≥n" }}</h2>
        <p class="form-subtitle">{{ isEditMode ? "Actualiza los detalles de la reparaci√≥n" : "Registra una nueva orden de reparaci√≥n" }}</p>
      </div>

      <form [formGroup]="form" (ngSubmit)="onSubmit()" class="repair-form">
        <!-- Informaci√≥n del cliente y dispositivo -->
        <div class="info-section">
          <h3 class="section-title">
            <span class="section-icon">üë§</span>
            Informaci√≥n del Cliente y Dispositivo
          </h3>
          
          <div class="form-row">
            <div class="form-group">
              <app-autocomplete
                [label]="'Cliente'"
                [icon]="'üë•'"
                [placeholder]="'Buscar cliente por nombre, apellido o tel√©fono...'"
                [searchFunction]="searchCustomers"
                [formatDisplayFn]="formatCustomerDisplay"
                [disabled]="isSubmitting"
                [required]="true"
                (itemSelected)="onCustomerSelected($event)">
              </app-autocomplete>
              @if (form.get('customerId')?.invalid && form.get('customerId')?.touched) {
                <div class="error-message">
                  <span class="error-icon">‚ö†Ô∏è</span>
                  El cliente es requerido
                </div>
              }
            </div>

            <div class="form-group">
              <app-autocomplete
                [label]="'Dispositivo'"
                [icon]="'üì±'"
                [placeholder]="'Buscar dispositivo por marca o modelo...'"
                [searchFunction]="searchPhones"
                [formatDisplayFn]="formatPhoneDisplay"
                [disabled]="isSubmitting"
                [required]="true"
                (itemSelected)="onPhoneSelected($event)">
              </app-autocomplete>
              @if (form.get('phoneId')?.invalid && form.get('phoneId')?.touched) {
                <div class="error-message">
                  <span class="error-icon">‚ö†Ô∏è</span>
                  El dispositivo es requerido
                </div>
              }
            </div>
          </div>
        </div>

        <!-- Vista previa de la reparaci√≥n -->
        @if (getSelectedCustomer() && getSelectedPhone()) {
          <div class="preview-section">
            <h3 class="section-title">
              <span class="section-icon">üëÅÔ∏è</span>
              Vista Previa de la Reparaci√≥n
            </h3>
            <div class="repair-preview">
              <div class="preview-card">
                <div class="customer-info">
                  <div class="preview-icon">üë§</div>
                  <div class="preview-details">
                    <h4>{{ getSelectedCustomer()?.name }} {{ getSelectedCustomer()?.lastname }}</h4>
                    <p>Cliente</p>
                  </div>
                </div>
                <div class="arrow">‚û°Ô∏è</div>
                <div class="device-info">
                  <div class="preview-icon">üì±</div>
                  <div class="preview-details">
                    <h4>{{ getSelectedPhone()?.brand }} {{ getSelectedPhone()?.model }}</h4>
                    <p>Dispositivo</p>
                  </div>
                </div>
                @if (getSelectedState()) {
                  <div class="arrow">‚û°Ô∏è</div>
                  <div class="status-info">
                    <div class="preview-icon" [style.background-color]="getSelectedState()?.color">üìä</div>
                    <div class="preview-details">
                      <h4>{{ getSelectedState()?.label }}</h4>
                      <p>Estado</p>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
        }

        <!-- Detalles de la reparaci√≥n -->
        <div class="info-section">
          <h3 class="section-title">
            <span class="section-icon">üîß</span>
            Detalles de la Reparaci√≥n
          </h3>
          
          <div class="form-group">
            <label class="form-label" for="fault">
              <span class="label-icon">‚ö†Ô∏è</span>
              Descripci√≥n de la Falla
            </label>
            <textarea 
              id="fault" 
              formControlName="fault" 
              class="form-textarea"
              placeholder="Describe detalladamente el problema del dispositivo..."
              rows="4"
              [disabled]="isSubmitting"
            ></textarea>
            @if (form.get('fault')?.invalid && form.get('fault')?.touched) {
              <div class="error-message">
                <span class="error-icon">‚ö†Ô∏è</span>
                La descripci√≥n de la falla es requerida
              </div>
            }
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label" for="state">
                <span class="label-icon">üìä</span>
                Estado
              </label>
              <select 
                id="state" 
                formControlName="state" 
                class="form-select" 
                required
                [disabled]="isSubmitting">
                <option value="" disabled>Selecciona el estado</option>
                @for (state of repairStates; track state.value) {
                  <option [value]="state.value">{{ state.label }}</option>
                }
              </select>
              @if (form.get('state')?.invalid && form.get('state')?.touched) {
                <div class="error-message">
                  <span class="error-icon">‚ö†Ô∏è</span>
                  El estado es requerido
                </div>
              }
            </div>

            <div class="form-group">
              <label class="form-label" for="date">
                <span class="label-icon">üìÖ</span>
                Fecha de Ingreso
              </label>
              <input 
                id="date" 
                type="date" 
                formControlName="date" 
                class="form-input"
                [max]="todayDate"
                [disabled]="isSubmitting"
              />
              @if (form.get('date')?.invalid && form.get('date')?.touched) {
                <div class="error-message">
                  <span class="error-icon">‚ö†Ô∏è</span>
                  La fecha es requerida
                </div>
              }
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="cancel()"
            [disabled]="isSubmitting">
            <span class="btn-icon">‚ùå</span>
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn-submit" 
            [disabled]="form.invalid || isSubmitting || !isFormReady">
            @if (isSubmitting) {
              <app-spinner size="small" color="white" [showMessage]="false"></app-spinner>
              {{ isEditMode ? "Actualizando..." : "Guardando..." }}
            } @else {
              <span class="btn-icon">{{ isEditMode ? "‚úèÔ∏è" : "üíæ" }}</span>
              {{ isEditMode ? "Actualizar" : "Guardar" }}
            }
          </button>
        </div>
      </form>
    </div>
  }
</div>
